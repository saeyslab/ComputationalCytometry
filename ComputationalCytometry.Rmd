---
title: "ComputationalCytometry"
author: "Katrien Quintelier"
date: "5/10/2022"
output: html_document
editor_options: 
  chunk_output_type: inline
---

# Install and load the libraries
## Install the libraries
```{r}
if (!requireNamespace("BiocManager", quietly = TRUE))
  install.packages("BiocManager")
BiocManager::install("flowCore")
BiocManager::install("ggplot2")
BiocManager::install("ggpubr")
BiocManager::install("pheatmap")
BiocManager::install("tidyr")
BiocManager::install("FlowSOM")
BiocManager::install("PeacoQC")
devtools::install_github("LKremer/ggpointdensity")
```

## Load the libraries
```{r}
library("flowCore") # For basic cytometry operations
library("ggplot2") # For nice plots
library("ggpubr")
library("pheatmap") # For pretty heatmap plots
library("tidyr")
library("FlowSOM") # For FlowSOM clustering and functions
library("PeacoQC") # For quality control
library("ggpointdensity") # For nice density plots

source("Extra_functions.R") # To load in additional functions
```


# Organization
## File organization
File organization should be:
ComputationalCytometry (main folder)
- Data
  + Raw
    ~ Control_Day1.fcs
    ~ Control_Day2.fcs
    ~ ManualLabeling.rds
    ~ Tube01_WT_Day1.fcs
    ~ Tube02_WT_Day1.fcs
    ~ Tube03_WT_Day2.fcs
    ~ Tube04_WT_Day2.fcs
    ~ Tube05_KO_Day1.fcs
    ~ Tube06_KO_Day1.fcs
    ~ Tube07_KO_Day2.fcs
    ~ Tube08_KO_Day2.fcs
 - Extra_functions.R
 - ComputationalCytometry.Rmd

## Directories
```{r}
# Set directories
dir_prepr <- "Data/Preprocessed/" #where the preprocessed data will be stored
dir_QC <- "Data/Preprocessed/QC/" #where the data QC results will be stored
dir_RDS <- "RDS/" #where the R objects will be stored
dir_results <- "Results/" #where the results will be stored
dir_raw <- "Data/Raw/" #where the raw data is located

# Create directories
for (path in c(dir_prepr, dir_QC, dir_RDS, dir_results)){
  dir.create(path)
}
```

# Data exploration
## Overview
Identify the fcs files of interest on the system
```{r}
getwd() # What is the current working directory?
# setwd() # To set the correct working directory

dir <- "Data/Raw" # Point to directory where the data is located
files <- list.files(dir, pattern = ".fcs", full.names = TRUE)
files
```

Load an fcs file into a flowFrame
```{r}
ff <- read.FCS(files[1])
ff
```

Check the expression matrix stored in the flowframe
```{r}
head(ff@exprs)
```

Check the metadata stored in the flowframe
```{r}
head(ff@description)
```

Check the channels and markers in the flowframe
```{r}
pData(ff@parameters)
```

##Exercise
How many events are measured in Tube 5?
```{r}
```

#Preprocessing

## Set some variables
```{r}
# List markers of interest
markers_of_interest <- c("SSC-A", "MHCII", "CD49b", "CD11b", "CD64",
                         "FcERI", "CD161", "Ly-6G", "CD3", "CD19", "CD11c")
channels_of_interest <- GetChannels(object = ff,
                                    markers = markers_of_interest, 
                                    exact = FALSE)

```


Plot two markers against each other in the traditional dot plot
```{r}
plotDens(ff = ff, 
         markers = c("CD3", "CD19"),
         adjust = 200)
```

Remove margins events
```{r}
ff_margins <- PeacoQC::RemoveMargins(ff, channels = channels_of_interest)
```

Plot Density
```{r}
plotDens(ff = ff_margins, 
         original_ff = ff,
         markers = c("FSC-A", "SSC-A"),
         adjust = 200)
```


Compensate the data with the spillover matrix acquired at the machine
```{r}
comp <- ff@description$SPILL
comp
ff_c <- compensate(ff_margins, comp)
```


```{r}
plotDens(ff = ff_c, 
         markers = c("CD3", "CD19"),
         adjust = 200)
```


Transform the data using an estimateLogicle on all files
```{r}
# Add Live Death channel to transform data and remove SSC from channels of interest
# since it needs its own transformation
channels_to_transform <- c(channels_of_interest[-1], GetChannels(ff, "L/D", exact = FALSE))

transformList <- estimateTransformation(files, channels_to_transform)

ff_t <- transform(ff_c, transformList)

#Special step to transform SSC-A
reference_marker <- "PE-A"
q5_goal <- quantile(exprs(ff_t)[,reference_marker], 0.05)
q95_goal <- quantile(exprs(ff_t)[,reference_marker], 0.95)
q5_SSCA <- quantile(exprs(ff_t)[,"SSC-A"], 0.05)
q95_SSCA <- quantile(exprs(ff_t)[,"SSC-A"], 0.95)
SSCA_a <- (q95_goal - q5_goal) / (q95_SSCA - q5_SSCA)
SSCA_b <- q5_goal - q5_SSCA * (q95_goal - q5_goal) / (q95_SSCA - q5_SSCA)
transformList <- c(transformList,
transformList("SSC-A", flowCore::linearTransform(a = SSCA_a,
b = SSCA_b)))

ff_t <- transform(ff_c, transformList)

plotDens(ff = ff_t, markers = c("CD3", "CD19"), adjust = 1)
```

Quality control

```{r}
ff_QC <- PeacoQC::PeacoQC(ff = ff_t, 
                          channels = channels_of_interest,
                          output_directory = dir_QC,
                          plot = FALSE)

plotDens(ff = ff_QC$FinalFF, original_ff = ff_t,markers = c("Time", "CD19"), adjust = 1)
```

Data filtering (can include removal of debris, doublets, dead cells, etc.)
```{r}
ff_doublets <- PeacoQC::RemoveDoublets(ff_QC$FinalFF)
plotDens(ff = ff_doublets, original_ff = ff_t, markers = c("FSC-A", "FSC-H"), adjust = 1)


# Remove dead cells
live_gate <- flowCore::polygonGate(filterId = "Live", 
                                   .gate = matrix(data = c(60000, 100000, 150000, 250000, 
                                                           250000, 60000, 60000, 1.6, 1.9, 
                                                           2.5, 2.5, -1.5, -1.5, 1.6), 
                                                  ncol = 2, 
                                                  dimnames = list(c(), c("FSC-A", "APC-Cy7-A"))))
selected_live <- filter(ff_doublets, live_gate) 
ff_l <- ff_doublets[selected_live@subSet,]
plotDens(ff = ff_l, original_ff = ff_doublets, markers = c("FSC-A", "APC-Cy7-A"), adjust = 1)

```

## Preprocessing all files
```{r}
for (file in files){
  
  print(file)
  
  ff <- read.FCS(file)
  ff_margins <- PeacoQC::RemoveMargins(ff, channels = channels_of_interest)
  p1 <- plotDens(ff = ff_margins, 
                 original_ff = ff, 
                 markers = c("FSC-A", "SSC-A"),
                 adjust = 200,
                 title = "Remove margins") 
  comp <- ff@description$SPILL
  
  ff_c <- compensate(ff_margins, comp)
  ff_t <- transform(ff_c, transformList)
  ff_QC <- PeacoQC::PeacoQC(ff = ff_t, channels = channels_of_interest, 
                            output_directory = dir_QC, plot = FALSE)
  p2 <- plotDens(ff = ff_QC$FinalFF, 
                 original_ff = ff_t,
                 markers = c("Time", "CD19"), 
                 adjust = 1,
                 title = "Remove low quality events")
  ff_doublets <- PeacoQC::RemoveDoublets(ff_QC$FinalFF)
  p3 <- plotDens(ff = ff_doublets, 
                 original_ff = ff_t, 
                 markers = c("FSC-A", "FSC-H"), 
                 adjust = 1,
                 title = "Remove doublets")

  selected_live <- filter(ff_doublets, live_gate) 
  ff_l <- ff_doublets[selected_live@subSet,]
  p4 <- plotDens(ff = ff_l, 
                 original_ff = ff_doublets, 
                 markers = c("FSC-A", "APC-Cy7-A"), 
                 adjust = 1,
                 title = "Remove dead cells")

  pdf(paste0(dir_QC, sub(".fcs", ".pdf", basename(file))), height = 3, width = 12)
  print(ggarrange(p1,p2,p3,p4, nrow = 1))
  dev.off()
  
  write.FCS(ff_l, file.path(dir_prepr, basename(file)))
}
```


## Exercise

Plot CD64 against FcERI for Tube 30
```{r}
```

# Evaluate quality of the data
## Plot the signal per channel and per file
```{r}
files <- list.files(path = dir_prepr, pattern = ".fcs", full.names = TRUE)[c(1, 3:4, 7:8, 2, 5:6, 9:10)]
files

day <- rep(c("Day1", "Day2"), each = 5)

PlotFileScatters(input = files,
                 channels = channels_of_interest,
                 names = basename(files), legend = TRUE,
                 groups = day, nrow = 2,
                 plotFile = paste0(dir_QC, "file_scatters.png"))
```



#Normalisation

#FlowSOm + analyse




