---
title: "ComputationalCytometry"
author: "Katrien Quintelier"
date: "5/10/2022"
output: html_document
editor_options: 
  chunk_output_type: inline
---

FlowSOM protocol: https://doi.org/10.1038/s41596-021-00550-0

# Install and load the libraries
## Install the libraries
```{r}
# if (!requireNamespace("BiocManager", quietly = TRUE))
#   install.packages("BiocManager")
# BiocManager::install("flowCore")
# BiocManager::install("ggplot2")
# BiocManager::install("ggpubr")
# BiocManager::install("pheatmap")
# BiocManager::install("tidyr")
# BiocManager::install("CytoML")
# devtools::install_github("LKremer/ggpointdensity")
# devtools::install_github("saeyslab/FlowSOM")
# devtools::install_github("saeyslab/PeacoQC")
# devtools::install_github("saeyslab/CytoNorm")
```

## Load the libraries
```{r}
library("flowCore") # For basic cytometry operations
library("ggplot2") # For nice plots
library("ggpubr")
library("pheatmap") # For pretty heatmap plots
library("tidyr")
library("FlowSOM") # For FlowSOM clustering and functions
library("PeacoQC") # For quality control
library("ggpointdensity") # For nice density plots
library("CytoNorm") # For normalization

source("Extra_functions.R") # To load in additional functions
```


# Organization
## File organization
File organization should be:
ComputationalCytometry (main folder)
- Background_material
- Data
  + AdditionalExercise
  + exampleMatrix.RDS
  + Raw
    ~ Control_Day1.fcs
    ~ Control_Day2.fcs
    ~ ManualLabeling.rds
    ~ Tube01_WT_Day1.fcs
    ~ Tube02_WT_Day1.fcs
    ~ Tube03_WT_Day2.fcs
    ~ Tube04_WT_Day2.fcs
    ~ Tube05_KO_Day1.fcs
    ~ Tube06_KO_Day1.fcs
    ~ Tube07_KO_Day2.fcs
    ~ Tube08_KO_Day2.fcs
 - Extra_functions.R
 - ComputationalCytometry.Rmd
 - FlowSOM_Cheatsheet.pdf

## Directories
```{r}
# Set directories
dir_prepr <- "Data/Preprocessed/" #where the preprocessed data will be stored
dir_QC <- "Data/Preprocessed/QC/" #where the data QC results will be stored
dir_RDS <- "RDS/" #where the R objects will be stored
dir_results <- "Results/" #where the results will be stored
dir_raw <- "Data/Raw/" #where the raw data is located

# Create directories
for (path in c(dir_prepr, dir_QC, dir_RDS, dir_results)){
  dir.create(path)
}
```

# Preprocessing
## List files
```{r}
getwd() # What is the current working directory?
# setwd() # To set the correct working directory

dir <- "Data/Raw" # Point to directory where the data is located
files <- list.files(dir, pattern = ".fcs", full.names = TRUE)
files
```

## Set some variables```{r}
# List markers of interest
markers_of_interest <- c("SSC-A", "MHCII", "CD49b", "CD11b", "CD64",
                         "FcERI", "CD161", "Ly-6G", "CD3", "CD19", "CD11c")
ff <- read.FCS(files[1])
channels_of_interest <- GetChannels(object = ff,
                                    markers = markers_of_interest, 
                                    exact = FALSE)

```


Plot two markers against each other in the traditional dot plot
```{r}
plotDens(ff = ff, 
         markers = c("CD3", "CD19"),
         adjust = 200)
```


## Compensate the data with the spillover matrix acquired at the machine
```{r}
comp <- ff@description$SPILL
comp
ff_c <- compensate(ff_margins, comp)
```


```{r}
plotDens(ff = ff_c, 
         markers = c("CD3", "CD19"),
         adjust = 200)
```


## Transform the data using an estimateLogicle on all files
```{r}
# Add Live Death channel to transform data and remove SSC from channels of interest
# since it needs its own transformation
channels_to_transform <- c(channels_of_interest[-1], GetChannels(ff, "L/D", exact = FALSE))

transformList <- estimateTransformation(files, channels_to_transform)

ff_t <- transform(ff_c, transformList)

#Special step to transform SSC-A
reference_marker <- "PE-A"
q5_goal <- quantile(exprs(ff_t)[,reference_marker], 0.05)
q95_goal <- quantile(exprs(ff_t)[,reference_marker], 0.95)
q5_SSCA <- quantile(exprs(ff_t)[,"SSC-A"], 0.05)
q95_SSCA <- quantile(exprs(ff_t)[,"SSC-A"], 0.95)
SSCA_a <- (q95_goal - q5_goal) / (q95_SSCA - q5_SSCA)
SSCA_b <- q5_goal - q5_SSCA * (q95_goal - q5_goal) / (q95_SSCA - q5_SSCA)
transformList <- c(transformList,
                   transformList("SSC-A", flowCore::linearTransform(a = SSCA_a,
b = SSCA_b)))

ff_t <- transform(ff_c, transformList)

plotDens(ff = ff_t, markers = c("CD3", "CD19"), adjust = 1)
```


## Preprocessing all files
```{r}
for (file in files){
  
  print(file)
  
  ff <- read.FCS(file)

  p1 <- plotDens(ff = ff, 
                 markers = c("FSC-A", "SSC-A"),
                 adjust = 200,
                 title = "Original file") 
  comp <- ff@description$SPILL
  
  ff_c <- compensate(ff, comp)
  ff_t <- transform(ff_c, transformList)
  
  p2 <- plotDens(ff = ff_t, 
                 markers = c("FSC-A", "SSC-A"), 
                 title = "Compensated and transformed file")
  
  png(paste0(dir_QC, sub(".fcs", ".png", basename(file))), height = 300, width = 600)
  print(ggarrange(p1, p2, nrow = 1))
  dev.off()
  
  write.FCS(ff_l, file.path(dir_prepr, basename(file)))
}
```


## Exercise
Plot CD64 against FcERI for Tube 5
```{r}
```

# Evaluate quality of the data
## Plot the signal per channel and per file
```{r}
files <- list.files(path = dir_prepr, pattern = ".fcs", full.names = TRUE)
files

order <- order(sub(".*(Day.).*", "\\1", files)) #To reorder files according to batch

files <- files[order]
files

day <- sub(".*(Day.).*", "\\1", files)
day

PlotFileScatters(input = files,
                 channels = channels_of_interest,
                 names = basename(files), legend = TRUE,
                 groups = day, nrow = 2,
                 plotFile = paste0(dir_QC, "file_scatters.png"))
```


# Make aggregate file
```{r}
files <- list.files(path = dir_prepr,
                    pattern = ".fcs",
                    full.names = TRUE)[order]
files

set.seed(2022)
agg <- AggregateFlowFrames(fileNames = files,
                           cTotal = 500000,
                           writeOutput = TRUE,
                           outputFile = paste0(dir_CytoNorm, "aggregate.fcs"))
```

# Make FlowSOM model 
FlowSOM https://doi.org/10.1002/cyto.a.22625
```{r}
fsom <- FlowSOM(input = agg,
                colsToUse = channels_of_interest,
                seed = 2022,
                nClus = 10,
                xdim = 10, ydim = 10)
saveRDS(fsom, paste0(dir_RDS, "fsom.rds"))

PlotStars(fsom = fsom,
          backgroundValues = fsom$metaclustering)
```

# Test FlowSOM quality
## Make 2D scatter plots
```{r}
channel_pairs = list(c("CD19", "SSC-A"),
                     c("CD3", "CD161"),
                     c("CD64", "CD49b"),
                     c("CD11c", "MHCII"),
                     c("Ly-6G", "CD11b"))

Plot2DScatters(fsom = fsom,
               channelpairs = channel_pairs,
               metaclusters = 1:10,
               clusters = 1,
               plotFile = paste0(dir_results, "fsom_2D_scatters.png"))
```

## Check consistency with manual gating
```{r}
manual <- readRDS("Data/Raw/ManualLabeling.rds")

agg_labels <- rep(NA, nrow(agg))
for (file_nr in unique(agg@exprs[,"File"])){
  man <- as.character(manual[[basename(files[file_nr])]])
  row_ids <- agg@exprs[,"File"] == file_nr
  agg_labels[row_ids] <- man[agg@exprs[,"Original_ID"][row_ids]]
}

PlotPies(fsom = fsom,
         cellTypes = factor(agg_labels,
                            levels = c("Unlabeled", "B cells", "T cells", "DCs", 
                                       "NK cells","Neutrophils", "Macrophages", 
                                       "NK T cells", "Basophils")))
ggsave("Results/fsom_manual.pdf")
```

## Calculate the purity of the FlowSOM clustering
Returns the mean purity score, worst purity score and number of clusters with score <0.75
```{r}
Purity(realClusters = agg_labels,
       predictedClusters = GetClusters(fsom))
```

## Inspect the file contribution per cluster
```{r}
file_colors <- c("#6a040f", "#9d0208", "#d00000", "#dc2f02", "#e85d04", #Different shades within the groups
                 "#03045e", "#023e8a", "#0077b6", "#0096c7", "#00b4d8") 

PlotPies(fsom = fsom,
         cellTypes = factor(basename(files)[fsom$data[,"File"]],
                           levels = basename(files)),
         colorPalette = file_colors)
ggsave(paste0(dir_results, "fsom_filecontribution.pdf"))
```

# Discovery and downstream analysis
## Eplore the FlowSOM result, make the FlowSOMmary
```{r}
FlowSOMmary(fsom = fsom,
            plotFile = paste0(dir_results, "fsom_summary.pdf"))
```

## Exercise
Plot a FlowSOM tree with the nodes colored according to CD19 expression. Hint: check the PlotMarker function in the FlowSOM_Cheatsheet.
```{r}

```


## Look for nodes with a specific pattern
```{r}
query <- list("B cells" = c("CD19" = "high", "CD3" = "low"),
              "NK cells" = c("CD19" = "low", "CD161" = "high", 
                             "MHCII" = "low"),
              "T cells" = c("CD3" = "high", "MHCII" = "low", "Ly-6G" = "low"),
              "Macrophages" = c("CD64" = "high", "FcERI" = "high", 
                                "MHCII" = "high", "CD49b" = "high", 
                                "Ly-6G" = "low"),
              "Dendritic cells" = c("CD11c" = "high", "MHCII" = "high", 
                                    "CD11b" = "high", "FcERI" = "low"),
              "Neutrophils" = c("Ly-6G" = "high", "CD11b" = "high", 
                                "CD3" = "low"))

labels <- QueryMultiple(fsom = fsom,
                        cellTypes = query,
                        plotFile = paste0(dir_results, "fsom_QueryStarPlot.pdf"))

PlotVariable(fsom = fsom,
             variable = labels)
ggsave(paste0(dir_results, "fsom_query.pdf"))
```

## Exercise
Annotate metaclusters
```{r}
PlotManualBars(fsom = fsom,
               manualVector = agg_labels)

fsom_annotated <- UpdateMetaclusters(fsom,
                                     newLabels = c("1" = "1: T cells",
                                                   "2" = "2: ",
                                                   "3" = "3: ",
                                                   "4" = "4: ",
                                                   "5" = "5: ",
                                                   "6" = "6: ",
                                                   "7" = "7: ",
                                                   "8" = "8: ",
                                                   "9" = "9: ",
                                                   "10" = "10: "))
```


## Get features per fcs file
```{r}
features <- GetFeatures(fsom = fsom_annotated,
                        files = files,
                        filenames = basename(files),
                        level = c("clusters", "metaclusters"),
                        type = c("counts", "MFI", "percentages"),
                        MFI = c("Ly-6G", "CD49b"))

names(features)
```

## Visualize features
```{r}
df <- data.frame(features$metacluster_percentages[c(2:5, 7:10),]*100, 
                 check.names = FALSE)
df$Group <- factor(x = c("WT", "WT", "KO", "KO",
                         "WT", "WT", "KO", "KO"))
df_g <- gather(df, "Feature", "Percentage", -Group)
df_g$Feature <- factor(x = df_g$Feature)
ggplot(data = df_g, aes(x=Group, y=Percentage))+
  geom_boxplot() +
  geom_point(aes(color=Group)) +
  facet_wrap(~Feature, scales = "free") +
  theme_minimal()
```

